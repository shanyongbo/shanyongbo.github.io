<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="shan&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      Python eval() - 动态执行表达式 | shan
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/plugins/gitment.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
    
<script src="/js/gitment.js"></script>

  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
<meta name="generator" content="Hexo 4.2.0"></head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>shan</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Python eval() - 动态执行表达式</h2>
  <p class="post-date">2020-05-13</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>本文是一篇关于python <strong><code>eval()</code></strong> 函数的翻译文章，为个人学习使用。</p>
<p>原文地址：<a href="https://realpython.com/python-eval-function/" target="_blank" rel="noopener">Python eval(): Evaluate Expressions Dynamically</a>  </p>
<p>进度：<strong>未完成</strong></p>
<p>Python 的 <strong><code>eval()</code></strong> 方法允许你去执行任意的基于字符串 (string-based) 或者基于编译代码(compiled-code-based) 的 python 表达式。当你尝试动态的执行基于字符串或者编译代码对象输入的 python 表达式的时候，这个函数就会变得非常有用。</p>
<p>尽管 python 的 <code>eval()</code> 函数是一个非常有用的工具，但是在使用这个函数之前你需要知道，它同样有一些安全隐患。在这篇文档中，你会了解到 <code>eval()</code> 如何工作的以及如何在你的 python 程序中安全有效的使用它。</p>
<p><strong>在这篇文档中，你将会了解</strong>：</p>
<ul>
<li>Python <strong><code>eval()</code></strong> 如何工作的</li>
<li>怎样去使用 <code>eval()</code> 去<strong>动态执行</strong>基于字符串或者基于编译代码的任意输入</li>
<li><code>eval()</code> 如何让你的代码变得不安全以及如何去最小化相关的<strong>安全风险</strong></li>
</ul>
<h2 id="Understanding-Python’s-eval"><a href="#Understanding-Python’s-eval" class="headerlink" title="Understanding Python’s eval()"></a>Understanding Python’s <code>eval()</code></h2><p>你可以使用 python 内置的函数 <strong><code>eval()</code></strong> 去动态执行基于字符串或者编译代码输入的表达式。如果你向<code>eval()</code> 方法传入一个字符串，那么接下来函数会去解析它，将它编译为字节码，然后作为Python表达式来执行。但是如果你用编译后的代码对象来调用 <code>eval()</code> 函数，那么函数就仅仅表现出执行步骤，如果你以相同的输入多次调用 <code>eval()</code> 方法，那么这么做是十分方便的。</p>
<p>Python <code>eval()</code> 的签名定义如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(expression[, globals[, locals]])</span><br></pre></td></tr></table></figure>

<p>这个函数接受的第一个参数，被称作为<strong>expression</strong>，它保存着你需要执行的表达式。<code>eval()</code> 也接受两个可选参数：</p>
<ol>
<li>globals</li>
<li>locals</li>
</ol>
<p>在接下来的三个部分，你会了解到这是哪个参数是什么以及<code>eval()</code> 如何使用它们去动态执行 Python 表达式。</p>
<p>Note: 你也可以使用 <strong><code>exec()</code></strong> 去动态的执行 Python 的代码。<code>eval()</code> 和 <code>exec()</code> 最主要的不同是 <code>eval()</code> 仅可以执行 Python 的表达式，而 <code>exec()</code> 可以执行任意的 Python 代码。</p>
<h3 id="The-First-Argument-expression"><a href="#The-First-Argument-expression" class="headerlink" title="The First Argument: expression"></a>The First Argument: <code>expression</code></h3><p><code>eval()</code> 的第一个参数被称为 <strong>expression</strong>. 它是必选参数，保存着传递给函数的<strong>基于字符串或者编译代码</strong>的输入。当你调用 <code>eval()</code> 时，expression 的内容作为 Python 表达式被执行。查看下面基于字符串输入的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"2 ** 8"</span>)</span><br><span class="line"><span class="number">256</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"1024 + 1024"</span>)</span><br><span class="line"><span class="number">2048</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"sum([8, 16, 32])"</span>)</span><br><span class="line"><span class="number">56</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">100</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x * 2"</span>)</span><br><span class="line"><span class="number">200</span></span><br></pre></td></tr></table></figure>

<p>当你使用字符串作为参数调用 <code>eval()</code> 的时候，函数的返回值是执行输入字符串得到的结果。因此，<code>eval()</code> 可以得到全局变量的值，比如上面例子中的 <code>x</code> 。</p>
<p>为了执行一个基于字符串的表达式，Python 的 eval() 会以下面的步骤运行：</p>
<ol>
<li><p><strong>解析</strong>表达式</p>
<ol start="2">
<li>将它<strong>编译</strong>为字节码</li>
<li>作为Python表达式进行<strong>执行</strong></li>
<li><strong>返回</strong>执行结果</li>
</ol>
</li>
</ol>
<p>变量 expression 作为 <code>eval()</code> 的第一个参数突出表达了函数仅和表达式一起工作而不是<a href="https://docs.python.org/zh-cn/3/reference/compound_stmts.html" target="_blank" rel="noopener">复合语句</a>。Python文档中关于expression的定义如下：</p>
<blockquote>
<p><strong>expression</strong></p>
<p>可以求出某个值的语法单元。 换句话说，一个表达式就是表达元素例如字面值、名称、属性访问、运算符或函数调用的汇总，它们最终都会返回一个值。 与许多其他语言不同，并非所有语言构件都是表达式。 还存在不能被用作表达式的 <a href="https://docs.python.org/zh-cn/3/glossary.html#term-statement" target="_blank" rel="noopener">statement</a>，例如 <a href="https://docs.python.org/zh-cn/3/reference/compound_stmts.html#while" target="_blank" rel="noopener"><code>while</code></a>。 赋值也是属于语句而非表达式。 (<a href="https://docs.python.org/zh-cn/3/glossary.html#term-expression" target="_blank" rel="noopener">Source</a>)</p>
</blockquote>
<p>另一方面，一个Python的语句有如下的定义：</p>
<blockquote>
<p><strong>statement</strong></p>
<p>语句是程序段(一个代码“块”)的组成单位。一条语句可以是一个 <a href="https://docs.python.org/zh-cn/3/glossary.html#term-expression" target="_blank" rel="noopener">expression</a> 或某个带有关键字的结构，例如 <a href="https://docs.python.org/zh-cn/3/reference/compound_stmts.html#if" target="_blank" rel="noopener"><code>if</code></a>、<a href="https://docs.python.org/zh-cn/3/reference/compound_stmts.html#while" target="_blank" rel="noopener"><code>while</code></a> 或 <a href="https://docs.python.org/zh-cn/3/reference/compound_stmts.html#for" target="_blank" rel="noopener"><code>for</code></a>。 (<a href="https://docs.python.org/zh-cn/3/glossary.html#term-statement" target="_blank" rel="noopener">Source</a>)</p>
</blockquote>
<p>如果你尝试传递一个复合语句给 <code>eval()</code>, 然后就会产生一个  <a href="https://realpython.com/invalid-syntax-python/" target="_blank" rel="noopener"><code>SyntaxError</code></a>。查看下面的例子，在这个例子中你尝试使用 <code>eval()</code> 执行一个 <strong>if 语句</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">100</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"if x: print(x)"</span>)</span><br><span class="line">  File <span class="string">"&lt;string&gt;"</span>, line <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> x: print(x)</span><br><span class="line">    ^</span><br><span class="line">SyntaxError: invalid syntax</span><br></pre></td></tr></table></figure>

<p>如果你尝试使用 Python 的 <code>eval()</code> 方法执行一个复合语句，那么你会得到一个像上面的 <a href="https://realpython.com/python-traceback/" target="_blank" rel="noopener">trackback</a> 一样的 <code>SyntaxError</code>。这是因为 <code>eval()</code> 仅仅只接受表达式(expressions)。任何其它的诸如 <code>if</code>, <code>for</code>, <code>while</code>, <code>import</code>, <code>def</code>, 或者 <code>class</code> 的语句， 都会产生一个<code>error</code>。</p>
<p><strong>Note</strong>:  一个 <code>for</code> 循环是一个复合语句，但是 <code>for</code> 关键字可以被用在<a href="https://realpython.com/courses/using-list-comprehensions-effectively/" target="_blank" rel="noopener">推导式 ( comprehensions )</a> 中，这被认为是一个表达式。你可以使用 <code>eval()</code> 去执行推导式 ( comprehensions ) 即使它使用了 <code>for</code> 关键字。</p>
<p>赋值操作也同样不被允许用在 <code>eval()</code> 中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"pi = 3.1416"</span>)</span><br><span class="line">  File <span class="string">"&lt;string&gt;"</span>, line <span class="number">1</span></span><br><span class="line">    pi = <span class="number">3.1416</span></span><br><span class="line">       ^</span><br><span class="line">SyntaxError: invalid syntax</span><br></pre></td></tr></table></figure>

<p>如果你尝试将赋值操作作为参数传递给 Python 的 <code>eval()</code> 函数，那么你会得到一个 <code>SynctaxError</code>。赋值操作是一个语句而不是表达式，并且语句是不被 <code>eval()</code> 允许的参数类型。</p>
<p>当解析器无法理解你输入的表达式时，你同样会得到一个 <code>SynctaxError</code>。接下来的例子中，尝试执行了一个违反 Python 语法的表达式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Incomplete expression</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"5 + 7 *"</span>)</span><br><span class="line">  File <span class="string">"&lt;string&gt;"</span>, line <span class="number">1</span></span><br><span class="line">    <span class="number">5</span> + <span class="number">7</span> *</span><br><span class="line">          ^</span><br><span class="line">SyntaxError: unexpected EOF <span class="keyword">while</span> parsing</span><br></pre></td></tr></table></figure>

<p>你不能传递一个违反Python语法的表达式给 <code>eval()</code> 。在上面的例子中，你尝试执行一个不完整的表达式 <code>( “5 + 7 *” )</code> 然后你得到了一个 <code>SynctaxError</code>，因为解析器不理解这个表达式的语法。</p>
<p>你同样可以传递一个编译过的代码对象给 Python 的 <code>eval()</code> 方法。为了编译能够传递给 <code>eval()</code> 的代码，你可以使用 <code>compile()</code> 函数。这是一个内置的函数，它可以将一个输入的字符串编译为<strong>代码对象</strong>或者一个<strong>抽象语法树对象( AST object)</strong> ，因此你可以用 <code>eval()</code> 方法执行编译过的代码。</p>
<p>如何使用compile() 方法的细节超过了这篇文章的范围，但是这里速览一下它的前三个必备参数：</p>
<ol>
<li><strong>source</strong> 保存了你想编译的源代码。这个参数接收通常的<strong>字符串</strong>，<strong>字节字符</strong>以及 <strong>AST对象</strong>。</li>
<li><strong>filename</strong> 给了读取代码的文件。如果你想使用一个基于字符串的输入，那么这个参数的值应该为 <code>“”</code>。</li>
<li><strong>mode</strong> 具体指明了你想得到什么类型的编译代码。如果你想使用 eval() 处理编译后的代码，那么这个参数需要被设置为 <code>“eval”</code>。</li>
</ol>
<p><strong>Note:</strong> 想获取更多关于 <code>compile()</code> 的信息，可以查看<a href="https://docs.python.org/zh-cn/3/library/functions.html#compile" target="_blank" rel="noopener">官方文档</a>。</p>
<p>你可以使用 <code>compile()</code> 将代码对象提供给 <code>eval()</code> ，而不是提供普通字符串。查看以下示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Arithmetic operations</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>code = compile(<span class="string">"5 + 4"</span>, <span class="string">"&lt;string&gt;"</span>, <span class="string">"eval"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(code)</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>code = compile(<span class="string">"(5 + 7) * 2"</span>, <span class="string">"&lt;string&gt;"</span>, <span class="string">"eval"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(code)</span><br><span class="line"><span class="number">24</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> math</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Volume of a sphere</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>code = compile(<span class="string">"4 / 3 * math.pi * math.pow(25, 3)"</span>, <span class="string">"&lt;string&gt;"</span>, <span class="string">"eval"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(code)</span><br><span class="line"><span class="number">65449.84694978735</span></span><br></pre></td></tr></table></figure>

<p>如果你使用compile() 来编译要传递给eval() 的表达式，则eval() 会经历以下步骤：</p>
<ol>
<li><strong>执行</strong>编译后的代码</li>
<li><strong>返回</strong>执行结果</li>
</ol>
<p>如果你使用基于编译代码的输入调用 Python 的<code>eval()</code>，则该函数将进行执行步骤并立即返回结果。当你需要多次执行同一个表达式时，这会十分方便。在这种情况下，最好预先编译表达式，并在随后对 <code>eval()</code> 的调用中重用结果字节码。</p>
<p>如果你预先编译输入表达式，则对 <code>eval()</code> 的后续调用将运行得更快，因为你将不会重复<strong>解析</strong>和<strong>编译</strong>步骤。如果你要执行复杂的表达式，不必要的重复会导致 CPU 时间增加以及过多的内存消耗。</p>
<h3 id="The-Second-Argument-globals"><a href="#The-Second-Argument-globals" class="headerlink" title="The Second Argument: globals"></a>The Second Argument: <code>globals</code></h3><p><code>eval()</code> 的第二个参数被称为 <code>globals</code> 。它是一个可选参数，保存着一个<a href="https://realpython.com/python-dicts/" target="_blank" rel="noopener">字典类型</a>。它为 <code>eval()</code> 函数提供一个全局的命名空间。有了 <code>globals</code>，你可以告诉 <code>eval()</code> 当执行 <code>expression</code> 时，哪个全局变量需要使用。</p>
<p>全局变量就是那些可以在你当前<a href="https://realpython.com/python-scope-legb-rule/#modules-the-global-scope" target="_blank" rel="noopener">全局作用域或者命名空间</a>中可以获得的变量。你可以在你代码的任意地方访问这些变量。</p>
<p>所有这些变量在一个字典中被传递给 <code>globals</code> ，当 <code>eval()</code> 执行的时候，可以获取到这些全局的变量。查看下面的例子，它展示了如何使用一个普通的字典去为 <code>eval()</code> 提供一个全局的命名空间。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">100</span>  <span class="comment"># A global variable</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x + 100"</span>, &#123;<span class="string">"x"</span>: x&#125;)</span><br><span class="line"><span class="number">200</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y = <span class="number">200</span>  <span class="comment"># Another global variable</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x + y"</span>, &#123;<span class="string">"x"</span>: x&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;string&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'y'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure>

<p>如果你为 <code>eval()</code> 的参数 <code>globals</code> 提供一个普通的字典，那么<code>eval()</code> 将只采用这个字典中的变量作为全局变量。任何其他定义在这个字典之外的全局变量都不能被 <code>eval()</code> 内部获得。这就是为什么当你在上面代码中尝试获取 <code>y</code> 时，Python 引发了一个 <code>NameError</code>：传递给 <code>globals</code> 的参数不包含 <code>y</code>。</p>
<p>你可以通过在你的字典中列举这些变量，然后向 globals 中插入这些变量，然后这些变量在执行期间就可以获取了。例如，如果你将 <code>y</code> 插入 <code>globals</code>，那么上面例子中 <code>“x + y”</code> 的执行就会如预期的那样。 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x + y"</span>, &#123;<span class="string">"x"</span>: x, <span class="string">"y"</span>: y&#125;)</span><br><span class="line"><span class="number">300</span></span><br></pre></td></tr></table></figure>

<p>一旦你把 <code>y</code> 加到 <code>globals</code> 的字典中，那么 <code>&quot;x + y&quot;</code> 的执行结果就会成功并且返回你预期中的值 300。</p>
<p>你也可以提供在你全局作用域中不存在的变量。因此你需要为每个变量提供一个具体的值。<code>eval()</code> 在执行的时候会当做全局变量来解释这些变量。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x + y + z"</span>, &#123;<span class="string">"x"</span>: x, <span class="string">"y"</span>: y, <span class="string">"z"</span>: <span class="number">300</span>&#125;)</span><br><span class="line"><span class="number">600</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>z</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'z'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure>

<p>即使你未在当前的全局作用域中定义 <code>z</code>，但该<a href="https://realpython.com/python-variables/" target="_blank" rel="noopener">变量</a>也存在于 <code>globals</code> 中，它的值为 300。在这种情况下，<code>eval()</code> 可以像访问全局变量一样访问 <code>z</code> 。</p>
<p><code>globals</code>背后的机制非常灵活。你可以将任何可见变量 ( 全局，局部或非局部) 传递给全局变量。你也可以在上面的示例中传递自定义键值对，例如 <code>&quot;z&quot;：300</code>。 <code>eval()</code> 会将它们全部视为全局变量。<br>关于全局变量重要的一点是，如果为其提供的自定义字典中不包含键”<code>__builtins__</code>“的值，则在解析表达式之前，将自动在 “<code>__builtins__</code>“ 下插入对内置字典的引用。这样可以确保 <code>eval()</code> 在执行表达式时将完全访问所有 Python 的内置变量。</p>
<p>以下示例显示，即使你为全局变量提供了一个空字典，对 <code>eval()</code> 的调用仍然可以访问 Python 的内置变量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"sum([2, 2, 2])"</span>, &#123;&#125;)</span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"min([1, 2, 3])"</span>, &#123;&#125;)</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"pow(10, 2)"</span>, &#123;&#125;)</span><br><span class="line"><span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>在上面的代码中，你为 globals 提供了一个空字典(<code>{}</code>)。因此字典中不包含名称为 “<code>__builtins__</code>“ 的键，Python自动插入了一个 <code>builtins</code> 的引用。因此，当 <code>eval()</code> 解析 <code>expression</code> 时，它能够获取所有的Python的内置变量。</p>
<p>如果当你调用 <code>eval()</code> 时，没有传递一个字典给 <code>globals</code> 参数 ，那么该参数将默认为在调用 <code>eval()</code> 的环境中由<a href="https://realpython.com/python-scope-legb-rule/#globals" target="_blank" rel="noopener"><code>globals()</code></a> 返回的字典。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">100</span>  <span class="comment"># A global variable</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y = <span class="number">200</span>  <span class="comment"># Another global variable</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x + y"</span>)  <span class="comment"># Access both global variables</span></span><br><span class="line"><span class="number">300</span></span><br></pre></td></tr></table></figure>

<p>当你在不提供 <code>globals</code> 参数的情况下调用 <code>eval()</code> 时，该函数将使用 <code>globals()</code>返回的字典作为其全局命名空间来执行 <code>expression</code> 。因此，在上面的示例中，你可以自由访问<code>x</code>和 <code>y</code>，因为它们是当前<a href="https://realpython.com/python-scope-legb-rule/#modules-the-global-scope" target="_blank" rel="noopener">global作用域</a>。</p>
<h3 id="The-Third-Argument-locals"><a href="#The-Third-Argument-locals" class="headerlink" title="The Third Argument: locals"></a>The Third Argument: <code>locals</code></h3><p>Python 的 <code>eval()</code> 函数接收的第三个参数称为 <code>locals</code> 。这是另一个可选参数，它保存着一个字典。在这种情况下，字典保包含 <code>eval()</code> 执行 <code>expression</code> 时当做局部变量的变量。</p>
<p>局部变量就是那些你定义在一个给定函数内部的变量 (<a href="https://realpython.com/python-variables/" target="_blank" rel="noopener">variables</a>, <a href="https://realpython.com/defining-your-own-python-function/" target="_blank" rel="noopener">functions</a>, <a href="https://realpython.com/courses/intro-object-oriented-programming-oop-python/" target="_blank" rel="noopener">classes</a>, and so on)。局部变量仅在函数内部可见。当你写一个函数的时候会定义这些类型的变量。</p>
<p>一旦 编写了 <code>eval()</code>，你不能向代码和局部作用域中添加局部变量。然而你可以传递一个字典给 <code>locals</code>, 然后 <code>eval()</code> 会把这些变量作为局部变量。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x + 100"</span>, &#123;&#125;, &#123;<span class="string">"x"</span>: <span class="number">100</span>&#125;)</span><br><span class="line"><span class="number">200</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x + y"</span>, &#123;&#125;, &#123;<span class="string">"x"</span>: <span class="number">100</span>&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;string&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'y'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure>

<p>第二个字典在第一次调用 <code>eval()</code> 时会保存变量 <code>x</code> 。这个变量被 <code>eval()</code> 解释为一个局部变量。从另一方面来说，它被视为 <code>eval()</code> 主体中定义的变量。</p>
<p>你可以在 <code>expression</code> 中使用 <code>x</code>，并且 <code>eval()</code> 会接受这个参数。相反的，如果你想使用 <code>y</code>，那么你会得到一个<code>NameError</code> ，因为 <code>y</code> 并没有在 <code>globals</code> 或者 <code>locals</code> 的命名空间中定义。</p>
<p>就如 <code>globals</code> 一样，你可以传递任何可见的参数 (global, local, 或者 nolocal) 给 <code>locals</code>。就如上面的例子中一样，你同样可以传递如 <code>“x”: 100</code> 这样的键值对。<code>eval()</code> 会把他们都作为局部变量。</p>
<p>需要注意的是，当你想提供一个字典给 <code>locals</code> 时，你首先需要提供一个字典给 <code>globals</code> 。在<code>eval()</code> 中是无法使用关键字的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x + 100"</span>, locals=&#123;<span class="string">"x"</span>: <span class="number">100</span>&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: eval() takes no keyword arguments</span><br></pre></td></tr></table></figure>

<p>如果你尝试在调用 <code>eval()</code> 时使用关键字参数，那么你会得到一个 <code>TypeError</code>，告诉你 <code>eval()</code> 不接受关键字参数。因此，你需要去提供一个 <code>globals</code> 参数的字典，然后才能使用 <code>locals</code> 的字典。</p>
<p>如果你不向 <code>locals</code> 提供一个字典，那么它默认指向传递给的字典。下面是一个关于你传递给 <code>globals</code> 一个空字典并且未传任何东西给 <code>locals</code> 的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">100</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x + 100"</span>, &#123;&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;string&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'x'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure>

<p>从上面可以看出，当你不传任何字典给<code>locals</code>时，参数默认为传递给 <code>globals</code> 的字典。在这种情矿下，<code>eval()</code> 无法获得 <code>x</code> 的值，因为 <code>globals</code> 字典为空。</p>
<p><code>globals</code> 和 <code>locals</code> 之间的主要实际区别在于，如果该 <code>globals</code> 中 <code>builtins</code> 键不存在，那么 Python会自动将 <code>__builtins__</code> 这个键插入到 <code>globals</code> 中。无论你是否向<code>globals</code>提供自定义词典，都会发生这种情况。另一方面，如果你向<code>locals</code>提供自定义字典，那么在执行<code>eval()</code>期间该字典将保持不变。</p>
<h2 id="Evaluating-Expressions-With-Python’s-eval"><a href="#Evaluating-Expressions-With-Python’s-eval" class="headerlink" title="Evaluating Expressions With Python’s eval()"></a>Evaluating Expressions With Python’s <code>eval()</code></h2><p>你可以使用 Python eval() 函数区执行任何除了python语句 (statements) 的python表达式 (expression)。例如基于关键字的复合语句或者赋值语句。</p>
<p><code>eval()</code> 函数在你需要动态执行python表达式的时候是非常有用的并且如果使用其他的python工具或者方法可能会增加你的开发时间或者精力。在这个部分，你会学到怎么使用python的 <code>eval()</code> 方法去执行 Boolean，math 以及普通目的的python表达式。</p>
<h3 id="Boolean-Expressions"><a href="#Boolean-Expressions" class="headerlink" title="Boolean Expressions"></a>Boolean Expressions</h3><p><a href="https://realpython.com/python-or-operator/#boolean-logic" target="_blank" rel="noopener">Boolean 表达式</a>是一个当解释器执行时返回真值 (True 或 False) 的 python 表达式。它们通常在 <code>if</code> 语句中执行。因为 Boolean 表达式不是复合语句，所以你可以使用 <code>eval()</code> 去执行它们。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">100</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y = <span class="number">100</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x != y"</span>)</span><br><span class="line"><span class="literal">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x &lt; 200 and y &gt; 100"</span>)</span><br><span class="line"><span class="literal">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x is y"</span>)</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x in &#123;50, 100, 150, 200&#125;"</span>)</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>你也可以在调用 <code>eval()</code> 过程中使用包含下面这些 Python 操作符的 Boolean 表达式：</p>
<ul>
<li><a href="https://docs.python.org/3/reference/expressions.html#value-comparisons" target="_blank" rel="noopener"><strong>Value comparison operators</strong></a>: <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>==</code>, <code>!=</code></li>
<li><a href="https://docs.python.org/3/reference/expressions.html#boolean-operations" target="_blank" rel="noopener"><strong>Logical (Boolean) operators</strong></a>: <code>and</code>, <a href="https://realpython.com/python-or-operator/" target="_blank" rel="noopener"><code>or</code></a>, <code>not</code></li>
<li><a href="https://docs.python.org/3/reference/expressions.html#membership-test-operations" target="_blank" rel="noopener"><strong>Membership test operators</strong></a>: <code>in</code>, <code>not in</code></li>
<li><a href="https://docs.python.org/3/reference/expressions.html#is-not" target="_blank" rel="noopener"><strong>Identity operators</strong></a>: <code>is</code>, <code>is not</code></li>
</ul>
<p>在这种情况下，函数返回你执行的表达式的真值结果。</p>
<p>现在，你可能在想，为啥我们要使用eval() 而不是直接使用Boolean表达式？想一下，假设你需要实现一个条件语句，但是你想在执行过程中改变这个条件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(a, b, condition)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">if</span> eval(condition):</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">return</span> a + b</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> a - b</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(<span class="number">2</span>, <span class="number">4</span>, <span class="string">"a &gt; b"</span>)</span><br><span class="line"><span class="number">-2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(<span class="number">2</span>, <span class="number">4</span>, <span class="string">"a &lt; b"</span>)</span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(<span class="number">2</span>, <span class="number">2</span>, <span class="string">"a is b"</span>)</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>在 <code>func()</code> 中，你使用 <code>eval()</code> 去执行提供的条件，然后决定返回的结果是由 <code>a+b</code> 或者 <code>a-b</code> 中的一个。在上面的示例中，你仅使用了几种不同的条件，但是只要你坚持使用在func() 中定义的名称 <code>a</code> 和 <code>b</code>，就可以使用任意数量的其他条件。</p>
<p>现在想象一下如何在不使用Python的<code>eval()</code>的情况下实现类似的功能。这样会减少代码和时间吗？肯定不行的！</p>
<h3 id="Math-Expressions"><a href="#Math-Expressions" class="headerlink" title="Math Expressions"></a>Math Expressions</h3><p>一个最常使用Python <code>eval()</code> 方法的地方就是计算基于字符输入的数学表达式。例如，当你想创造一个<a href="https://realpython.com/python-pyqt-gui-calculator/" target="_blank" rel="noopener">python 的计算器</a>时，你就可以使用eval() 去执行用户的输入然后返回计算的结果。</p>
<p>下面就是一个使用 <code>eval()</code> 如何执行数学运算的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Arithmetic operations</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"5 + 7"</span>)</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"5 * 7"</span>)</span><br><span class="line"><span class="number">35</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"5 ** 7"</span>)</span><br><span class="line"><span class="number">78125</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"(5 + 7) / 2"</span>)</span><br><span class="line"><span class="number">6.0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> math</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Area of a circle</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"math.pi * pow(25, 2)"</span>)</span><br><span class="line"><span class="number">1963.4954084936207</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Volume of a sphere</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"4 / 3 * math.pi * math.pow(25, 3)"</span>)</span><br><span class="line"><span class="number">65449.84694978735</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Hypotenuse of a right triangle</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"math.sqrt(math.pow(10, 2) + math.pow(15, 2))"</span>)</span><br><span class="line"><span class="number">18.027756377319946</span></span><br></pre></td></tr></table></figure>

<p>当你使用 <code>eval()</code> 去执行数学表达式的时候，你可以传递任何复杂程度的表达式。<code>eval()</code> 会解析它们，执行它们，如果一切正常的情况下，会返回你预期的结果。</p>
<h3 id="General-Purpose-Expressions"><a href="#General-Purpose-Expressions" class="headerlink" title="General-Purpose Expressions"></a>General-Purpose Expressions</h3><p>到目前为止，你知道了如何使用eval() 去执行Boolean和数学表达式。然而，你可以使用eval() 去执行更加复杂的Python表达式，包括函数调用，对象创建，属性获取，推导式等等。</p>
<p>例如，你可以调用一个内置函数或者你导入的标准库或者三方模块：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Run the echo command</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"subprocess.getoutput('echo Hello, World')"</span>)</span><br><span class="line"><span class="string">'Hello, World'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Launch Firefox (if available)</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"subprocess.getoutput('firefox')"</span>)</span><br><span class="line"><span class="string">''</span></span><br></pre></td></tr></table></figure>

<p>在这个例子中，你使用 Python <code>eval()</code> 去执行一些系统的命令。正如你想的那样，你可以使用这个特性做大量的有用的事情。然而，<code>eval()</code> 也会导致一系列的安全隐患，例如，允许一些恶意用户在你的机器上运行系统命令或者任意的代码。</p>
<p>在下一节，你会了解到在使用 <code>eval()</code> 时解决这些安全隐患的方法。</p>
<h2 id="Minimizing-the-Security-Issues-of-eval"><a href="#Minimizing-the-Security-Issues-of-eval" class="headerlink" title="Minimizing the Security Issues of eval()"></a>Minimizing the Security Issues of <code>eval()</code></h2><p>尽管Python的 <code>eval()</code> 方法非常的有用，但是它也会导致一些严重的安全隐患。<code>eval()</code> 是不够安全的，因为它允许你去动态的执行任意的Python代码。</p>
<p>这被认为是坏的编程习惯，因为你读取的或者写的代码不是你马上要执行的代码。如果你打算使用 eval() 方法去执行从某个用户或者其他外部来源的输入，那么你并不清楚什么样的代码会被执行。如果你的应用被错误的运行，那么这就会变为非常严重的安全隐患。</p>
<p>因为这个原因，好的编程习惯一般建议你不去使用eval() 方法。但是如果你决定无论如何都要使用这个方法，那么经验法则就是绝对不要使用不信任的输入。该规则的棘手部分是弄清楚你可以信任的输入类型。</p>
<p>举个例子说明如何不负责任地使用<code>eval()</code>会使你的代码不安全，假设你想构建一个在线服务来执行任意Python表达式。你的用户使用表达式，然后单击 <strong>运行</strong> 按钮。该应用程序会获取用户的输入并将其传递给<code>eval()</code>进行执行。</p>
<p>该应用程序将在你的个人服务器上运行。在这个服务器上拥有你的所有有价值的文件。如果你运行的是Linux机器，并且应用程序的进程具有正确的权限，则恶意用户可能会引入以下危险字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"__import__('subprocess').getoutput('rm –rf *')"</span></span><br></pre></td></tr></table></figure>

<p>上面的代码会删除这个应用当前目录下的所有文件。</p>
<p>*<em>NOTE: *</em> <a href="https://docs.python.org/3/library/functions.html#__import__" target="_blank" rel="noopener"><code>__import__()</code></a> 是一个内置函数，它将模块名称作为字符串并返回对模块对象的引用。<br><code>__import__()</code> 是一个函数，它与 <code>import</code> 语句完全不同。你无法使用<code>eval()</code> 执行<code>import</code>语句。</p>
<p>当输入不受信任时，没有完全有效的方法来避免与 <code>eval()</code> 相关的安全风险。但是，你可以通过限制<code>eval()</code> 的执行环境来最大程度地降低风险。在以下各节中，你将学习一些这样做的技术。</p>
<h3 id="Restricting-globals-and-locals"><a href="#Restricting-globals-and-locals" class="headerlink" title="Restricting globals and locals"></a>Restricting <code>globals</code> and <code>locals</code></h3><p>你可以通过将自定义字典传递给 <code>globals</code> 和 <code>locals</code> 参数限制 <code>eval()</code> 执行的环境。例如，你可以传递空字典给两个参数以防止eval() 访问调用者<a href="https://realpython.com/python-scope-legb-rule/#python-scope-vs-namespace" target="_blank" rel="noopener">当前的作用域或者命名空间</a>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Avoid access to names in the caller's current scope</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">100</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"x * 5"</span>, &#123;&#125;, &#123;&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;string&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'x'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure>

<p>如果你向 <code>globals</code> 和 <code>locals</code> 传递空字典 (<code>{}</code>)，那么 <code>eval()</code> 在执行字符串 <code>x * 5</code> 时不会在全局命名空间或者它的局部命名空间中找到变量 <code>x</code>。作为结果，<code>eval()</code> 会抛出一个 <code>NameError</code>。</p>
<p>不幸的是，像这样限制 <code>globals</code> 和 <code>locals</code> 参数并不能消除所有使用Python的 <code>eval()</code> 相关的所有安全风险，因为你仍然可以访问所有Python的内置变量。</p>
<h3 id="Restricting-the-Use-of-Built-In-Names"><a href="#Restricting-the-Use-of-Built-In-Names" class="headerlink" title="Restricting the Use of Built-In Names"></a>Restricting the Use of Built-In Names</h3><p>如前所述，Python的<code>eval()</code>在解析 <code>expression</code> 之前会自动将对 <code>builtins</code> 字典的引用插入 <code>globals</code> 中。恶意用户可以通过使用内置函数 <code>__import__()</code>来利用此行为，以访问标准库和系统上已安装的任何第三方模块。</p>
<p>下面例子说明，即使你已限制 <code>globals</code> 和 <code>locals</code> ，也可以使用任何内置函数和任何标准模块(如 <code>math</code> 或 <code>subprocess</code>)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"sum([5, 5, 5])"</span>, &#123;&#125;, &#123;&#125;)</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"__import__('math').sqrt(25)"</span>, &#123;&#125;, &#123;&#125;)</span><br><span class="line"><span class="number">5.0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"__import__('subprocess').getoutput('echo Hello, World')"</span>, &#123;&#125;, &#123;&#125;)</span><br><span class="line"><span class="string">'Hello, World'</span></span><br></pre></td></tr></table></figure>

<p>即使你使用空字典限制了<code>globals</code>和<code>locals</code>，但是你仍然可以使用任何内置函数，就像在上面的代码中对<code>sum()</code>和<code>__import__()</code>所做的一样。</p>
<p>你可以使用<code>__import__()</code>来导入任何标准或第三方模块，就像上面对<code>math</code>和<code>subprocess</code>所做的一样。使用这种技术，你可以访问在 <code>math</code>，<code>subprocess</code>或任何其他模块中定义的任何函数或类。现在想象一下，恶意用户可以使用 <code>subprocess</code> 或标准库中的任何其他功能强大的模块对你的系统进行操作。</p>
<p>为了最大程度地降低这种风险，你可以通过覆盖 <code>globals</code> 中的 <code>__builtins__</code> 键来限制对Python内置函数的访问。较好的做法建议使用包含键值对 <code>&quot;__builtins__&quot;: {}</code>的自定义词典。查看下面的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(<span class="string">"__import__('math').sqrt(25)"</span>, &#123;<span class="string">"__builtins__"</span>: &#123;&#125;&#125;, &#123;&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;string&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'__import__'</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure>

<p>如果你将包含键值对<code>&quot;__builtins__&quot;: {}</code>的字典传递给<code>globals</code>，则<code>eval()</code>将无法直接访问Python的内置函数，例如<code>__import__()</code>。但是，正如你将在下一节中看到的那样，这种方法仍无法完全使 <code>eval()</code> 安全。</p>
<h3 id="Restricting-Names-in-the-Input"><a href="#Restricting-Names-in-the-Input" class="headerlink" title="Restricting Names in the Input"></a>Restricting Names in the Input</h3><p>即使你可以使用自定义全局变量和局部变量字典来限制Python的 <code>eval()</code> 的执行环境，该函数仍然容易受到一些特殊技巧的攻击。例如，你可以使用类型字符如“”，[]，{}或 () 以及一些特殊属性来访问类对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">""</span>.__class__.__base__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">object</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; [].<span class="title">__class__</span>.<span class="title">__base__</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">object</span>'&gt;</span></span><br><span class="line">&gt;&gt;&gt; &#123;&#125;.__class__.__base__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">object</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="params">()</span>.<span class="title">__class__</span>.<span class="title">__base__</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">object</span>'&gt;</span></span><br></pre></td></tr></table></figure>

<p>一旦你访问了<code>object</code>后，你就可以使用特殊方法<a href="https://docs.python.org/3/library/stdtypes.html#class.__subclasses__" target="_blank" rel="noopener"><code>.__ subclasses__()</code></a>来访问所有继承自object的类。方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; for sub_class in ().__class__.__base__.__subclasses__():</span><br><span class="line">...     print(sub_class.__name__)</span><br><span class="line">...</span><br><span class="line">type</span><br><span class="line">weakref</span><br><span class="line">weakcallableproxy</span><br><span class="line">weakproxy</span><br><span class="line">int</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>此代码会将大量的类列表打印到屏幕上。其中一些类非常强大，如果使用不当，可能会非常危险。这就打开了另一个重要的安全漏洞，你只是简单地限制<code>eval()</code>的执行环境是无法解决该漏洞的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>input_string = <span class="string">"""[</span></span><br><span class="line"><span class="string"><span class="meta">... </span>    c for c in ().__class__.__base__.__subclasses__()</span></span><br><span class="line"><span class="string"><span class="meta">... </span>    if c.__name__ == "range"</span></span><br><span class="line"><span class="string"><span class="meta">... </span>][0](10)"""</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(eval(input_string, &#123;<span class="string">"__builtins__"</span>: &#123;&#125;&#125;, &#123;&#125;))</span><br><span class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br></pre></td></tr></table></figure>

<p>上面代码中的列表推导式会过滤从 <code>object</code> 对象继承的类，返回包含 类 <a href="https://realpython.com/python-range/" target="_blank" rel="noopener"><code>range</code></a> 的 <code>list</code> 。第一个索引(<code>[0]</code>)返回类 <code>rassssnge</code>。一旦可以访问 <code>range</code>，就可以调用它来生成 <code>range</code> 对象。然后，你在 <code>range</code> 对象上调用<code>list()</code> 以生成十个整数的列表。</p>
<p>在这个例子中，使用的<code>range</code>方法来说明 <code>eval()</code> 中的安全漏洞。想象一下，如果你的系统暴露了<a href="https://docs.python.org/3/library/subprocess.html#subprocess.Popen" target="_blank" rel="noopener"><code>subprocess.Popen</code></a>之类的类，恶意用户会做什么。 </p>
<p>*<em>Note: *</em> 想要深入了解 <code>eval()</code> 方法的漏洞，请查看 Ned Batchelder 的文章：<a href="http://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html" target="_blank" rel="noopener">Eval确实很危险</a>。该漏洞的一种可能解决方案是将输入中变量的使用限制为 safe名称或这没有任何变量。要实现此方法，你需要执行以下步骤：</p>
<ol>
<li><strong>创建</strong>包含要与<code>eval()</code>一起使用的名称的字典。 </li>
<li>在模式 “eval” 下，使用 <code>compile()</code> 将输入字符串<strong>编译</strong>为字节码。 </li>
<li><strong>检查</strong>字节码对象上的 <code>.co_names</code> 以确保它仅包含允许的变量。 </li>
<li>如果用户尝试输入不允许的变量，请<strong>引发</strong>一个 <code>NameError</code>。</li>
</ol>
<p>看一下实现所有这些步骤的函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">eval_expression</span><span class="params">(input_string)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="comment"># Step 1</span></span><br><span class="line"><span class="meta">... </span>    allowed_names = &#123;<span class="string">"sum"</span>: sum&#125;</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># Step 2</span></span><br><span class="line"><span class="meta">... </span>    code = compile(input_string, <span class="string">"&lt;string&gt;"</span>, <span class="string">"eval"</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="comment"># Step 3</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">for</span> name <span class="keyword">in</span> code.co_names:</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> allowed_names:</span><br><span class="line"><span class="meta">... </span>            <span class="comment"># Step 4</span></span><br><span class="line"><span class="meta">... </span>            <span class="keyword">raise</span> NameError(<span class="string">f"Use of <span class="subst">&#123;name&#125;</span> not allowed"</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> eval(code, &#123;<span class="string">"__builtins__"</span>: &#123;&#125;&#125;, allowed_names)</span><br></pre></td></tr></table></figure>

<p>在<code>eval_expression()</code>中，你实现了之前看到的所有步骤。该函数将可以与<code>eval()</code>一起使用的变量限制为仅字典<code>allowed_names</code>中的那些变量。为此，该函数使用<code>.co_names</code>，它是代码对象的一个属性，返回包含代码对象中的名称的<a href="https://realpython.com/python-lists-tuples/#python-tuples" target="_blank" rel="noopener">元组</a>。</p>
<p>以下示例显示了<code>eval_expression()</code>在实际中的工作方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval_expression(<span class="string">"3 + 4 * 5 + 25 / 2"</span>)</span><br><span class="line"><span class="number">35.5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval_expression(<span class="string">"sum([1, 2, 3])"</span>)</span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval_expression(<span class="string">"len([1, 2, 3])"</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">10</span>, <span class="keyword">in</span> eval_expression</span><br><span class="line">NameError: Use of len <span class="keyword">not</span> allowed</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval_expression(<span class="string">"pow(10, 2)"</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">10</span>, <span class="keyword">in</span> eval_expression</span><br><span class="line">NameError: Use of pow <span class="keyword">not</span> allowed</span><br></pre></td></tr></table></figure>

<p>如果你调用 <code>eval_expression()</code> 来执行算术运算，或者使用包含允许名称的表达式，则将获得预期的结果。否则，你会收到 <code>NameError</code>。在上述示例中，你唯一允许使用的名称是<code>sum()</code>。不允许使用诸如 <code>len()</code> 和 <code>pow()</code> 之类的其他名称，因此当你尝试使用它们时，该函数会引发<code>NameError</code>。</p>
<p>如果你想完全禁止使用名称，则可以如下重写<code>eval_expression()</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">eval_expression</span><span class="params">(input_string)</span>:</span></span><br><span class="line"><span class="meta">... </span>    code = compile(input_string, <span class="string">"&lt;string&gt;"</span>, <span class="string">"eval"</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">if</span> code.co_names:</span><br><span class="line"><span class="meta">... </span>        <span class="keyword">raise</span> NameError(<span class="string">f"Use of names not allowed"</span>)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> eval(code, &#123;<span class="string">"__builtins__"</span>: &#123;&#125;&#125;, &#123;&#125;)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval_expression(<span class="string">"3 + 4 * 5 + 25 / 2"</span>)</span><br><span class="line"><span class="number">35.5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval_expression(<span class="string">"sum([1, 2, 3])"</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">4</span>, <span class="keyword">in</span> eval_expression</span><br><span class="line">NameError: Use of names <span class="keyword">not</span> allowed</span><br></pre></td></tr></table></figure>

<p>现在，你的函数不允许输入字符串中的任何名称。要做到这一点，你需要检查 <code>.co_names</code> 中的名称，如果发现一个名称，则会引发<code>NameError</code>。否则，你将执行<code>input_string</code>并返回执行结果。在这种情况下，你还可以使用空字典来限制<code>locals</code>。</p>
<p>你可以使用此技术来最小化<code>eval()</code>的安全问题，并增强防御恶意攻击的能力。</p>
<p>Now your function doesn’t allow <em>any</em> names in the input string. To accomplish this, you check for names in <code>.co_names</code> and raise a <code>NameError</code> if one is found. Otherwise, you evaluate <code>input_string</code> and return the result of the evaluation. In this case, you use an empty dictionary to restrict <code>locals</code> as well.</p>
<p>You can use this technique to minimize the security issues of <code>eval()</code> and strengthen your armor against malicious attacks.</p>
<h3 id="Restricting-the-Input-to-Only-Literals"><a href="#Restricting-the-Input-to-Only-Literals" class="headerlink" title="Restricting the Input to Only Literals"></a>Restricting the Input to Only Literals</h3><p>Python的<code>eval()</code>的一个常见用例是执行包含标准Python文字的字符串，并将其转换为具体对象。标准库提供了一个名为<a href="https://docs.python.org/3/library/ast.html#ast.literal_eval" target="_blank" rel="noopener"><code>literal_eval()</code></a>的函数，可以帮助实现此目标。</p>
<p>该函数不支持运算符，但支持<a href="https://realpython.com/python-lists-tuples/" target="_blank" rel="noopener">列表，元组</a>，数字，字符串等：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> ast <span class="keyword">import</span> literal_eval</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Evaluating literals</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>literal_eval(<span class="string">"15.02"</span>)</span><br><span class="line"><span class="number">15.02</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>literal_eval(<span class="string">"[1, 15]"</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">15</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>literal_eval(<span class="string">"(1, 15)"</span>)</span><br><span class="line">(<span class="number">1</span>, <span class="number">15</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>literal_eval(<span class="string">"&#123;'one': 1, 'two': 2&#125;"</span>)</span><br><span class="line">&#123;<span class="string">'one'</span>: <span class="number">1</span>, <span class="string">'two'</span>: <span class="number">2</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Trying to evaluate an expression</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>literal_eval(<span class="string">"sum([1, 15]) + 5 + 8 * 2"</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">ValueError: malformed node <span class="keyword">or</span> string: &lt;_ast.BinOp object at <span class="number">0x7faedecd7668</span>&gt;</span><br></pre></td></tr></table></figure>

<p>注意，<code>literal_eval()</code>仅适用于标准类型文字。它不支持使用运算符或变量。如果你尝试将表达式提供给 <code>literal_eval()</code>，则会收到 <code>ValueError</code>。此函数还可以帮助你将与使用Python的 <code>eval()</code> 相关的安全风险降至最低。</p>
<h2 id="Using-Python’s-eval-With-input"><a href="#Using-Python’s-eval-With-input" class="headerlink" title="Using Python’s eval() With input()"></a>Using Python’s <code>eval()</code> With <code>input()</code></h2><p>在<a href="https://realpython.com/products/python-basics-book" target="_blank" rel="noopener">Python 3.x</a>中，内置的<a href="https://docs.python.org/3/library/functions.html#input" target="_blank" rel="noopener"><strong><code>input()</code></strong></a>在命令行中读取用户输入，将其转换为字符串，剥离尾部的换行符，然后将结果返回给调用方。由于 <code>input()</code> 的结果是一个字符串，因此你可以将其输入到 <code>eval()</code> 并将其作为Python表达式求值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(input(<span class="string">"Enter a math expression: "</span>))</span><br><span class="line">Enter a math expression: <span class="number">15</span> * <span class="number">2</span></span><br><span class="line"><span class="number">30</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>eval(input(<span class="string">"Enter a math expression: "</span>))</span><br><span class="line">Enter a math expression: <span class="number">5</span> + <span class="number">8</span></span><br><span class="line"><span class="number">13</span></span><br></pre></td></tr></table></figure>

<p>你可以将 Python 的 <code>eval()</code> 包裹在 <code>input()</code> 之上，以自动执行用户的输入。这是 <code>eval()</code> 的常见用例，因为它模拟了 Python 2.x 中<a href="https://docs.python.org/2/library/functions.html#input" target="_blank" rel="noopener"><code>input()</code>的行为</a>，其中，<code>input()</code> 将用户的输入执行为 Python 表达式并返回结果。</p>
<p>由于其安全性，Python 2.x 中的 <code>input()</code> 行为已在 Python 3.x 中更改。</p>
<h2 id="Building-a-Math-Expressions-Evaluator"><a href="#Building-a-Math-Expressions-Evaluator" class="headerlink" title="Building a Math Expressions Evaluator"></a>Building a Math Expressions Evaluator</h2><p>到目前为止，你已经了解了 Python 的 <code>eval()</code> 的工作原理以及如何在实践中使用它。你还了解到 <code>eval()</code> 具有重要的安全隐患，并且通常被认为要避免在代码中使用 <code>eval()</code> 。但是，在某些情况下，Python的 <code>eval()</code> 可以为你节省大量时间和精力。</p>
<p>在本部分中，你会编写代码以动态执行数学表达式。如果你想在不使用 <code>eval()</code> 的情况下解决此问题，则需要执行以下步骤：</p>
<ol>
<li><strong>解析</strong>输入表达式。</li>
<li>将表达式的组件<strong>更改</strong>为Python对象(数字，运算符，函数等)。</li>
<li>将所有内容<strong>组合</strong>成一个表达式。</li>
<li><strong>确认</strong>该表达式在Python中有效。</li>
<li><strong>执行</strong>最终表达式并返回结果。</li>
</ol>
<p>考虑到Python可以处理和执行的各种可能的表达式，这会花费大量的时间。幸运的是，你可以使用 <code>eval()</code> 解决此问题，并且你已经学习了几种降低相关安全风险的方法。</p>
<p>首先，创建一个名为 <code>mathrepl.py</code> 的 Python 脚本，然后添加以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> <span class="keyword">import</span> math</span><br><span class="line"> <span class="number">2</span> </span><br><span class="line"> <span class="number">3</span> __version__ = <span class="string">"1.0"</span></span><br><span class="line"> <span class="number">4</span> </span><br><span class="line"> <span class="number">5</span> ALLOWED_NAMES = &#123;</span><br><span class="line"> <span class="number">6</span>     k: v <span class="keyword">for</span> k, v <span class="keyword">in</span> math.__dict__.items() <span class="keyword">if</span> <span class="keyword">not</span> k.startswith(<span class="string">"__"</span>)</span><br><span class="line"> <span class="number">7</span> &#125;</span><br><span class="line"> <span class="number">8</span> </span><br><span class="line"> <span class="number">9</span> PS1 = <span class="string">"mr&gt;&gt;"</span></span><br><span class="line"><span class="number">10</span> </span><br><span class="line"><span class="number">11</span> WELCOME = <span class="string">f"""</span></span><br><span class="line"><span class="string">12 MathREPL <span class="subst">&#123;__version__&#125;</span>, your Python math expressions evaluator!</span></span><br><span class="line"><span class="string">13 Enter a valid math expression after the prompt "<span class="subst">&#123;PS1&#125;</span>".</span></span><br><span class="line"><span class="string">14 Type "help" for more information.</span></span><br><span class="line"><span class="string">15 Type "quit" or "exit" to exit.</span></span><br><span class="line"><span class="string">16 """</span></span><br><span class="line"><span class="number">17</span> </span><br><span class="line"><span class="number">18</span> USAGE = <span class="string">f"""</span></span><br><span class="line"><span class="string">19 Usage:</span></span><br><span class="line"><span class="string">20 Build math expressions using numeric values and operators.</span></span><br><span class="line"><span class="string">21 Use any of the following functions and constants:</span></span><br><span class="line"><span class="string">22 </span></span><br><span class="line"><span class="string">23 <span class="subst">&#123;<span class="string">', '</span>.join(ALLOWED_NAMES.keys())&#125;</span></span></span><br><span class="line"><span class="string">24 """</span></span><br></pre></td></tr></table></figure>

<p>在这段代码中，你首先导入 Python 的 <code>math</code> 模块。该模块将允许你使用预定义的函数和常量执行数学运算。常量 <code>ALLOWED_NAMES</code> 保存一个字典，其中包含 <code>math</code> 中的非特殊名称。这样，你就可以将它们与<code>eval()</code>一起使用。</p>
<p>你还定义了三个字符串常量。你将使用它们作为脚本的用户界面，并根据需要将它们打印到屏幕上。</p>
<p>现在，你可以编写应用程序的核心功能了。在这种情况下，你需要编写一个函数来接收数学表达式作为输入并返回其结果。为此，你编写了一个名为<code>evaluate()</code>的函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">26 def evaluate(expression):</span><br><span class="line">27     &quot;&quot;&quot;Evaluate a math expression.&quot;&quot;&quot;</span><br><span class="line">28     # Compile the expression</span><br><span class="line">29     code &#x3D; compile(expression, &quot;&lt;string&gt;&quot;, &quot;eval&quot;)</span><br><span class="line">30 </span><br><span class="line">31     # Validate allowed names</span><br><span class="line">32     for name in code.co_names:</span><br><span class="line">33         if name not in ALLOWED_NAMES:</span><br><span class="line">34             raise NameError(f&quot;The use of &#39;&#123;name&#125;&#39; is not allowed&quot;)</span><br><span class="line">35 </span><br><span class="line">36     return eval(code, &#123;&quot;__builtins__&quot;: &#123;&#125;&#125;, ALLOWED_NAMES)</span><br></pre></td></tr></table></figure>

<p>该函数的工作方式如下：</p>
<ol>
<li>在<strong>第26行</strong>中，定义<code>evaluate()</code>。该函数以字符串 <code>expression</code> 作为参数，并返回一个<a href="https://realpython.com/lessons/floats/" target="_blank" rel="noopener">float</a>，该值表示将字符串作为数学表达式求值的结果。 </li>
<li>在<strong>第29行</strong>中，使用 <code>compile()</code> 将输入字符串 <code>expression</code> 转换为已编译的 Python 代码。如果用户输入无效的表达式，则编译操作将引发<code>SyntaxError</code>。 </li>
<li>在<strong>第32行</strong>中，启动 <code>for</code> 循环以检查 <code>expression</code> 中包含的名称，并确认可以在最终表达式中使用它们。如果用户提供的名称不在允许的名称列表中，则引发 <code>NameError</code>。 </li>
<li>在<strong>第36行</strong>中，对数学表达式进行实际执行。注意，按照惯例，你将自定义字典传递给 <code>globals</code> 和<code>locals</code>。 <code>ALLOWED_NAMES</code> 保存在 <code>math</code> 中定义的函数和常量。</li>
</ol>
<p><strong>注意：</strong>由于此应用程序使用了<code>math</code>中定义的函数，因此你需要考虑到当使用无效输入值调用它们时，其中一些函数会引发<code>ValueError</code>。</p>
<p>例如，math.sqrt(-10)会引发错误，因为-10的<a href="https://realpython.com/python-square-root-function/" target="_blank" rel="noopener">平方根</a> 未定义。</p>
<p>稍后，你将在客户端代码中看到如何捕获此错误。对<code>globals</code>和<code>locals</code>参数使用自定义值，以及对<strong>line<code>33</code></strong>中的名称进行检查，可以使与<code>eval（)</code>相关的安全风险降至最低。</p>
<p>当你在<a href="https://realpython.com/python-main-function" target="_blank" rel="noopener"><code>main()</code></a>中编写其客户端代码时，你的数学表达式执行器将要完成。在此函数中，你将定义程序的主循环，并关闭读取和执行用户在命令行中输入的表达式的周期。</p>
<p>对于此示例，应用程序将：</p>
<ol>
<li>向用户<strong>打印</strong>欢迎消息</li>
<li><strong>显示</strong>提示，准备读取用户的输入</li>
<li><strong>提供</strong>选项以获取使用说明并终止应用程序</li>
<li><strong>读取</strong>用户的数学表达式</li>
<li><strong>执行</strong>用户的数学表达式</li>
<li>将执行结果<strong>打印</strong>到屏幕上</li>
</ol>
<p>检验以下<code>main()</code>实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">38</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"><span class="number">39</span>     <span class="string">"""Main loop: Read and evaluate user's input."""</span></span><br><span class="line"><span class="number">40</span>     print(WELCOME)</span><br><span class="line"><span class="number">41</span>     <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="number">42</span>         <span class="comment"># Read user's input</span></span><br><span class="line"><span class="number">43</span>         <span class="keyword">try</span>:</span><br><span class="line"><span class="number">44</span>             expression = input(<span class="string">f"<span class="subst">&#123;PS1&#125;</span> "</span>)</span><br><span class="line"><span class="number">45</span>         <span class="keyword">except</span> (KeyboardInterrupt, EOFError):</span><br><span class="line"><span class="number">46</span>             <span class="keyword">raise</span> SystemExit()</span><br><span class="line"><span class="number">47</span> </span><br><span class="line"><span class="number">48</span>         <span class="comment"># Handle special commands</span></span><br><span class="line"><span class="number">49</span>         <span class="keyword">if</span> expression.lower() == <span class="string">"help"</span>:</span><br><span class="line"><span class="number">50</span>             print(USAGE)</span><br><span class="line"><span class="number">51</span>             <span class="keyword">continue</span></span><br><span class="line"><span class="number">52</span>         <span class="keyword">if</span> expression.lower() <span class="keyword">in</span> &#123;<span class="string">"quit"</span>, <span class="string">"exit"</span>&#125;:</span><br><span class="line"><span class="number">53</span>             <span class="keyword">raise</span> SystemExit()</span><br><span class="line"><span class="number">54</span> </span><br><span class="line"><span class="number">55</span>         <span class="comment"># Evaluate the expression and handle errors</span></span><br><span class="line"><span class="number">56</span>         <span class="keyword">try</span>:</span><br><span class="line"><span class="number">57</span>             result = evaluate(expression)</span><br><span class="line"><span class="number">58</span>         <span class="keyword">except</span> SyntaxError:</span><br><span class="line"><span class="number">59</span>             <span class="comment"># If the user enters an invalid expression</span></span><br><span class="line"><span class="number">60</span>             print(<span class="string">"Invalid input expression syntax"</span>)</span><br><span class="line"><span class="number">61</span>             <span class="keyword">continue</span></span><br><span class="line"><span class="number">62</span>         <span class="keyword">except</span> (NameError, ValueError) <span class="keyword">as</span> err:</span><br><span class="line"><span class="number">63</span>             <span class="comment"># If the user tries to use a name that isn't allowed</span></span><br><span class="line"><span class="number">64</span>             <span class="comment"># or an invalid value for a given math function</span></span><br><span class="line"><span class="number">65</span>             print(err)</span><br><span class="line"><span class="number">66</span>             <span class="keyword">continue</span></span><br><span class="line"><span class="number">67</span> </span><br><span class="line"><span class="number">68</span>         <span class="comment"># Print the result if no error occurs</span></span><br><span class="line"><span class="number">69</span>         print(<span class="string">f"The result is: <span class="subst">&#123;result&#125;</span>"</span>)</span><br><span class="line"><span class="number">70</span> </span><br><span class="line"><span class="number">71</span> <span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line"><span class="number">72</span>     main()</span><br></pre></td></tr></table></figure>

<p>在<code>main()</code>内部，首先打印 <code>WELCOME</code> 消息。然后，你会在<a href="https://docs.python.org/3/reference/compound_stmts.html#the-try-statement" target="_blank" rel="noopener"><code>try</code>语句</a>中读取用户的输入，以捕获<code>KeyboardInterrupt</code> 和 <code>EOFError</code>。</p>
<p>如果这些异常之一发生，则终止应用程序。如果用户输入 <code>help</code> 选项，则应用程序将显示你的 <code>USAGE</code> 。<br>同样，如果用户输入 <code>quit</code> 或 <code>exit</code>，则应用程序终止。</p>
<p>最后，你使用 <code>evaluate()</code> 计算用户的数学表达式，然后将结果打印到屏幕上。请务必注意，对<code>evaluate()</code>的调用会引发以下异常：</p>
<p><strong>SyntaxError</strong>：当用户输入不遵循 Python 语法的表达式时，就会发生这种情况。 </p>
<p><strong>NameError</strong>：当用户尝试使用不允许的名称(函数，类或属性)时，会发生这种情况。 </p>
<p><strong>ValueError</strong>：当用户尝试使用不允许在 <code>math</code> 中给定函数输入的值时，会发生这种情况。` </p>
<p><strong>注意:</strong> 在 <code>main()</code> 中，你捕获了所有这些异常并相应地向用户打印消息。这将使用户可以查看表达式，解决问题并再次运行程序。而已！</p>
<p>你已经使用Python的 <code>eval()</code> 在大约70行代码中构建了一个数学表达式执行器。要<a href="https://realpython.com/run-python-scripts/" target="_blank" rel="noopener">运行应用程序</a>，请打开系统的命令行，然后输入以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> python3 mathrepl.py</span></span><br></pre></td></tr></table></figure>

<p>此命令将启动数学表达式执行器的<a href="https://realpython.com/python-command-line-arguments/#the-command-line-interface" target="_blank" rel="noopener">命令行界面</a>(CLI)。你会在屏幕上看到以下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MathREPL 1.0, your Python math expressions evaluator!</span><br><span class="line">Enter a valid math expression after the prompt "mr&gt;&gt;".</span><br><span class="line">Type "help" for more information.</span><br><span class="line">Type "quit" or "exit" to exit.</span><br><span class="line"></span><br><span class="line"><span class="meta">mr&gt;</span><span class="bash">&gt;</span></span><br></pre></td></tr></table></figure>

<p>在那里，你可以输入和执行任何数学表达式。例如，键入以下表达式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mr&gt;&gt; <span class="number">25</span> * <span class="number">2</span></span><br><span class="line">The result <span class="keyword">is</span>: <span class="number">50</span></span><br><span class="line">mr&gt;&gt; sqrt(<span class="number">25</span>)</span><br><span class="line">The result <span class="keyword">is</span>: <span class="number">5.0</span></span><br><span class="line">mr&gt;&gt; pi</span><br><span class="line">The result <span class="keyword">is</span>: <span class="number">3.141592653589793</span></span><br></pre></td></tr></table></figure>

<p>如果输入有效的数学表达式，则应用程序将对其求值并将结果打印到屏幕上。如果你的表达式有任何问题，那么应用程序将告诉你：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mr&gt;&gt; <span class="number">5</span> * (<span class="number">25</span> + <span class="number">4</span></span><br><span class="line">Invalid input expression syntax</span><br><span class="line">mr&gt;&gt; sum([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line">The use of <span class="string">'sum'</span> <span class="keyword">is</span> <span class="keyword">not</span> allowed</span><br><span class="line">mr&gt;&gt; sqrt(<span class="number">-15</span>)</span><br><span class="line">math domain error</span><br><span class="line">mr&gt;&gt; factorial(<span class="number">-15</span>)</span><br><span class="line">factorial() <span class="keyword">not</span> defined <span class="keyword">for</span> negative values</span><br></pre></td></tr></table></figure>

<p>在第一个示例中，你错过了右括号，因此你收到一条消息，告诉你语法不正确。然后，调用 <code>sum()</code> (这是不允许的)，并得到一条说明性错误消息。最后，你使用无效的输入值调用“数学”函数，应用程序会生成一条消息，指出你输入中的问题。</p>
<p>你的数学表达式执行器已经准备就绪！你可以随时添加一些额外的功能。</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>你可以使用 Python 的 <code>eval()</code> 来执行基于字符串或基于代码的输入中的 Python 表达式。当你尝试动态执行Python 表达式并且希望避免从头开始创建自己的表达式计算器时，此内置函数会很有用。</p>
<p>在本教程中，你学习了 <code>eval()</code> 的工作方式以及如何安全有效地使用它来执行任意 Python 表达式。 </p>
<p><strong>你现在能够：</strong></p>
<p>使用Python的<code>eval()</code>动态<strong>执行</strong>基本的Python表达式</p>
<p>运行更复杂的语句，例如<strong>函数调用</strong>，<strong>对象创建</strong>和使用 <code>eval()</code> 进行属性访问</p>
<p>最大限度地<strong>减少与使用Python的 <code>eval()</code> 相关的安全风险</strong></p>
<p>此外，你还编写了一个使用<code>eval()</code>进行交互执行的应用程序使用<a href="https://realpython.com/command-line-interfaces-python-argparse/" target="_blank" rel="noopener">命令行界面</a>的数学表达式。</p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#python" >
    <span class="tag-code">python</span>
  </a>

  <a href="/tags#eval" >
    <span class="tag-code">eval</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2020/05/12/python-virtual-machine/">
        <span class="nav-arrow">← </span>
        
          Inside The Python Virtual Machine
        
      </a>
    
    
      <a class="nav-right" href="/2020/05/15/2020-05-15-Python-concurrent-futures%20%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E5%B9%B6%E5%8F%91/">
        
          Python concurrent.futures 模块实现并发
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">扫描二维码，分享此文章</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Gitment START -->
      <div id="comments"></div>
      <!-- Gitment END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Understanding-Python’s-eval"><span class="toc-nav-text">Understanding Python’s eval()</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#The-First-Argument-expression"><span class="toc-nav-text">The First Argument: expression</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#The-Second-Argument-globals"><span class="toc-nav-text">The Second Argument: globals</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#The-Third-Argument-locals"><span class="toc-nav-text">The Third Argument: locals</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Evaluating-Expressions-With-Python’s-eval"><span class="toc-nav-text">Evaluating Expressions With Python’s eval()</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Boolean-Expressions"><span class="toc-nav-text">Boolean Expressions</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Math-Expressions"><span class="toc-nav-text">Math Expressions</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#General-Purpose-Expressions"><span class="toc-nav-text">General-Purpose Expressions</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Minimizing-the-Security-Issues-of-eval"><span class="toc-nav-text">Minimizing the Security Issues of eval()</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Restricting-globals-and-locals"><span class="toc-nav-text">Restricting globals and locals</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Restricting-the-Use-of-Built-In-Names"><span class="toc-nav-text">Restricting the Use of Built-In Names</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Restricting-Names-in-the-Input"><span class="toc-nav-text">Restricting Names in the Input</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Restricting-the-Input-to-Only-Literals"><span class="toc-nav-text">Restricting the Input to Only Literals</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Using-Python’s-eval-With-input"><span class="toc-nav-text">Using Python’s eval() With input()</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Building-a-Math-Expressions-Evaluator"><span class="toc-nav-text">Building a Math Expressions Evaluator</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Conclusion"><span class="toc-nav-text">Conclusion</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://shanyongbo.github.io/2020/05/13/2020-05-13-python-eval-动态计算表达式/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>



  <script>
    var gitmentConfig = "shan";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "Python eval() - 动态执行表达式",
        owner: "shan",
        repo: "shan.github.io",
        oauth: {
          client_id: "0f87e490e00ee3fd87ef",
          client_secret: "4a9d2b148e7971c2201ad12131ce8bf8159ccd2e"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  </script>




    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2020 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a href="https://github.com/yanm1ng" target="_blank" rel="noopener">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>

  </body>
</html>